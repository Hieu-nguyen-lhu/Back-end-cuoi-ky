<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üõçÔ∏è Qu·∫£n L√Ω B√°n H√†ng</h1>
            <div id="navMenu" class="nav-menu">
                <a href="index.html" class="nav-link">Trang Ch·ªß</a>
                <a href="products.html" class="nav-link" id="navProducts" style="display:none;">S·∫£n Ph·∫©m</a>
                <a href="admin-products.html" class="nav-link" id="navAdmin" style="display:none;">Qu·∫£n L√Ω S·∫£n Ph·∫©m</a>
                <a href="admin-orders.html" class="nav-link" id="navAdminOrders" style="display:none;">Qu·∫£n L√Ω ƒê∆°n H√†ng</a>
                <a href="cart.html" class="nav-link" id="navCart" style="display:none;">
                    üõí Gi·ªè H√†ng <span id="cartCount" class="badge">0</span>
                </a>
                <button id="logoutBtn" class="logout-btn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Qu·∫£n L√Ω S·∫£n Ph·∫©m</h2>
        
        <button id="addNewBtn" class="btn btn-primary" style="margin-bottom: 20px;">+ Th√™m S·∫£n Ph·∫©m</button>

        <table class="table" id="productsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n S·∫£n Ph·∫©m</th>
                    <th>Gi√°</th>
                    <th>T·ªìn Kho</th>
                    <th>M√¥ T·∫£</th>
                    <th>H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody id="productsBody">
            </tbody>
        </table>

        <div id="noProducts" class="message message-info">
            ƒêang t·∫£i s·∫£n ph·∫©m...
        </div>
    </div>

    <!-- Modal th√™m/s·ª≠a s·∫£n ph·∫©m -->
    <div id="productModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle">Th√™m S·∫£n Ph·∫©m</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="name">T√™n S·∫£n Ph·∫©m:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="price">Gi√°:</label>
                    <input type="number" id="price" name="price" min="0" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="stock">T·ªìn Kho:</label>
                    <input type="number" id="stock" name="stock" min="0" required>
                </div>
                <div class="form-group">
                    <label for="description">M√¥ T·∫£:</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="image">H√¨nh ·∫¢nh:</label>
                    <input type="file" id="image" name="image" accept="image/*">
                    <small>H√¨nh ·∫£nh s·∫Ω ƒë∆∞·ª£c l∆∞u trong th∆∞ m·ª•c uploads</small>
                </div>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <button type="button" class="btn btn-secondary close-modal">ƒê√≥ng</button>
            </form>
            <div id="formMessage" class="message" style="display:none;"></div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let editingProductId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('Admin');
            updateNavigation();
            loadProducts();
            setupModal();
        });

        async function loadProducts() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/products`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('L·ªói t·∫£i s·∫£n ph·∫©m');

                const data = await response.json();
                const products = data.data;
                const productsBody = document.getElementById('productsBody');
                const noProducts = document.getElementById('noProducts');
                const productsTable = document.getElementById('productsTable');

                if (products.length === 0) {
                    productsTable.style.display = 'none';
                    noProducts.textContent = 'Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o';
                    noProducts.style.display = 'block';
                    return;
                }

                productsBody.innerHTML = '';
                noProducts.style.display = 'none';
                productsTable.style.display = 'table';

                products.forEach(product => {
                    const row = document.createElement('tr');
                    const description = product.description || '-';
                    const displayDesc = description.length > 30 ? description.substring(0, 30) + '...' : description;
                    const imageHtml = (product.imageUrl && product.imageUrl.trim() !== '') 
                        ? `<img src="${product.imageUrl}" style="max-width: 40px; max-height: 40px; margin-right: 8px;" alt="${product.name}" onerror="this.style.display='none'">`
                        : '';
                    
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>
                            ${imageHtml}
                            ${product.name}
                        </td>
                        <td>${product.price.toLocaleString('vi-VN')} VNƒê</td>
                        <td>${product.stock}</td>
                        <td title="${description}">${displayDesc}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">S·ª≠a</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">X√≥a</button>
                        </td>
                    `;
                    productsBody.appendChild(row);
                });
            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('noProducts').textContent = 'L·ªói t·∫£i s·∫£n ph·∫©m';
                document.getElementById('noProducts').style.display = 'block';
            }
        }

        function setupModal() {
            const modal = document.getElementById('productModal');
            const closeBtn = document.querySelector('.close');
            const closeModalBtn = document.querySelector('.close-modal');
            const addNewBtn = document.getElementById('addNewBtn');

            addNewBtn.onclick = () => openModal();
            closeBtn.onclick = () => modal.style.display = 'none';
            closeModalBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };

            document.getElementById('productForm').onsubmit = submitForm;
        }

        function openModal(productId = null) {
            editingProductId = productId;
            const modal = document.getElementById('productModal');
            const form = document.getElementById('productForm');
            const title = document.getElementById('modalTitle');
            const imageInput = document.getElementById('image');

            form.reset();
            document.getElementById('formMessage').style.display = 'none';

            if (productId) {
                title.textContent = 'S·ª≠a S·∫£n Ph·∫©m';
                imageInput.style.display = 'none';
                document.querySelector('label[for="image"]').style.display = 'none';
                loadProductToForm(productId);
            } else {
                title.textContent = 'Th√™m S·∫£n Ph·∫©m';
                imageInput.style.display = 'block';
                document.querySelector('label[for="image"]').style.display = 'block';
            }

            modal.style.display = 'block';
        }

        async function loadProductToForm(productId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/products/${productId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                const product = data.data;

                document.getElementById('name').value = product.name;
                document.getElementById('price').value = product.price;
                document.getElementById('stock').value = product.stock;
                document.getElementById('description').value = product.description || '';
            } catch (error) {
                console.error('L·ªói:', error);
                showFormMessage('L·ªói t·∫£i th√¥ng tin s·∫£n ph·∫©m', 'error');
            }
        }

        async function submitForm(e) {
            e.preventDefault();

            const name = document.getElementById('name').value;
            const price = parseFloat(document.getElementById('price').value);
            const stock = parseInt(document.getElementById('stock').value);
            const description = document.getElementById('description').value;
            const imageFile = document.getElementById('image').files[0];

            const token = localStorage.getItem('token');
            const method = editingProductId ? 'PUT' : 'POST';
            const url = editingProductId 
                ? `${API_URL}/products/${editingProductId}`
                : `${API_URL}/products`;

            let imageUrl = null;

            try {
                // N·∫øu c√≥ file h√¨nh ·∫£nh, upload tr∆∞·ªõc
                if (imageFile) {
                    const uploadFormData = new FormData();
                    uploadFormData.append('file', imageFile);

                    const uploadResponse = await fetch(`${API_URL}/upload/product-image`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: uploadFormData
                    });

                    if (!uploadResponse.ok) {
                        const uploadError = await uploadResponse.json();
                        throw new Error(uploadError.message || 'L·ªói upload h√¨nh ·∫£nh');
                    }

                    const uploadData = await uploadResponse.json();
                    imageUrl = uploadData.data.url;
                }

                const requestBody = {
                    name: name,
                    price: price,
                    stock: stock,
                    description: description || null,
                    imageUrl: imageUrl
                };

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'L·ªói l∆∞u s·∫£n ph·∫©m');
                }

                showFormMessage(editingProductId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!', 'success');
                
                setTimeout(() => {
                    document.getElementById('productModal').style.display = 'none';
                    loadProducts();
                }, 1000);
            } catch (error) {
                console.error('L·ªói:', error);
                showFormMessage('L·ªói: ' + error.message, 'error');
            }
        }

        function editProduct(productId) {
            openModal(productId);
        }

        async function deleteProduct(productId) {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('L·ªói x√≥a s·∫£n ph·∫©m');

                alert('X√≥a s·∫£n ph·∫©m th√†nh c√¥ng!');
                loadProducts();
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        function showFormMessage(msg, type) {
            const messageDiv = document.getElementById('formMessage');
            messageDiv.textContent = msg;
            messageDiv.className = `message message-${type}`;
            messageDiv.style.display = 'block';
        }
    </script>
</body>
</html>
