<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n H√†ng C·ªßa T√¥i</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üõçÔ∏è Qu·∫£n L√Ω B√°n H√†ng</h1>
            <div id="navMenu" class="nav-menu">
                <a href="index.html" class="nav-link">Trang Ch·ªß</a>
                <a href="products.html" class="nav-link" id="navProducts" style="display:none;">S·∫£n Ph·∫©m</a>
                <a href="admin-products.html" class="nav-link" id="navAdmin" style="display:none;">Qu·∫£n L√Ω S·∫£n Ph·∫©m</a>
                <a href="admin-orders.html" class="nav-link" id="navAdminOrders" style="display:none;">Qu·∫£n L√Ω ƒê∆°n H√†ng</a>
                <a href="my-orders.html" class="nav-link" id="navMyOrders" style="display:none;">ƒê∆°n H√†ng C·ªßa T√¥i</a>
                <a href="cart.html" class="nav-link" id="navCart" style="display:none;">
                    üõí Gi·ªè H√†ng <span id="cartCount" class="badge">0</span>
                </a>
                <button id="logoutBtn" class="logout-btn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>ƒê∆°n H√†ng C·ªßa T√¥i</h2>

        <table class="table" id="ordersTable" style="display:none;">
            <thead>
                <tr>
                    <th>M√£ ƒê∆°n</th>
                    <th>Ng√†y ƒê·∫∑t</th>
                    <th>T·ªïng Ti·ªÅn</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
            </tbody>
        </table>

        <div id="noOrders" class="message message-info">
            ƒêang t·∫£i ƒë∆°n h√†ng...
        </div>
    </div>

    <!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
    <div id="orderModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close">&times;</span>
            <h3>Chi ti·∫øt ƒë∆°n h√†ng #<span id="modalOrderId"></span></h3>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>S·ªë ƒêi·ªán Tho·∫°i:</strong> <span id="modalPhoneNumber"></span></p>
                        <p><strong>Ng√†y ƒë·∫∑t:</strong> <span id="modalOrderDate"></span></p>
                    </div>
                    <div>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span id="modalOrderStatus"></span></p>
                        <p><strong>T·ªïng ti·ªÅn:</strong> <span id="modalOrderTotal"></span> VNƒê</p>
                        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> <span id="modalDeliveryAddress"></span></p>
                    </div>
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">Chi ti·∫øt s·∫£n ph·∫©m:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>S·∫£n Ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>S·ªë L∆∞·ª£ng</th>
                            <th>Th√†nh Ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="modalOrderItems">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('User');
            updateNavigation();
            loadMyOrders();
            setupModal();
        });

        async function loadMyOrders() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/orders/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('L·ªói t·∫£i ƒë∆°n h√†ng');
                }

                const data = await response.json();
                let orders = Array.isArray(data) ? data : (data.data || []);

                const ordersBody = document.getElementById('ordersBody');
                const noOrders = document.getElementById('noOrders');
                const ordersTable = document.getElementById('ordersTable');

                if (orders.length === 0) {
                    ordersTable.style.display = 'none';
                    noOrders.textContent = 'B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o. H√£y ti·∫øp t·ª•c mua s·∫Øm';
                    noOrders.style.display = 'block';
                    return;
                }

                ordersBody.innerHTML = '';
                noOrders.style.display = 'none';
                ordersTable.style.display = 'table';

                orders.forEach(order => {
                    const row = document.createElement('tr');
                    const statusBadge = getStatusBadge(order.status);
                    const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('vi-VN') : 'N/A';
                    const totalAmount = order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') : '0';
                    
                    row.innerHTML = `
                        <td>#${order.id}</td>
                        <td>${orderDate}</td>
                        <td>${totalAmount} VNƒê</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewOrderDetails(${order.id})">Chi ti·∫øt</button>
                        </td>
                    `;
                    ordersBody.appendChild(row);
                });
            } catch (error) {
                console.error('L·ªói:', error);
                const noOrders = document.getElementById('noOrders');
                const ordersTable = document.getElementById('ordersTable');
                ordersTable.style.display = 'none';
                noOrders.textContent = 'L·ªói t·∫£i ƒë∆°n h√†ng: ' + error.message;
                noOrders.style.display = 'block';
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                'Pending': '<span style="background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Ch·ªù x·ª≠ l√Ω</span>',
                'Confirmed': '<span style="background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒê√£ x√°c nh·∫≠n</span>',
                'Shipped': '<span style="background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒêang v·∫≠n chuy·ªÉn</span>',
                'Delivered': '<span style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒê√£ giao</span>',
                'Cancelled': '<span style="background-color: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">H·ªßy b·ªè</span>'
            };
            return statusMap[status] || status;
        }

        async function viewOrderDetails(orderId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                }

                const data = await response.json();
                const order = data.data || data;

                // Hi·ªÉn th·ªã th√¥ng tin ƒë∆°n h√†ng
                document.getElementById('modalOrderId').textContent = order.id || '';
                document.getElementById('modalPhoneNumber').textContent = order.phoneNumber || 'N/A';
                document.getElementById('modalDeliveryAddress').textContent = order.deliveryAddress || 'N/A';
                document.getElementById('modalOrderDate').textContent = order.orderDate ? new Date(order.orderDate).toLocaleDateString('vi-VN') : 'N/A';
                document.getElementById('modalOrderStatus').textContent = getStatusText(order.status) || 'N/A';
                document.getElementById('modalOrderTotal').textContent = order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') : '0';

                // Hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m
                const itemsBody = document.getElementById('modalOrderItems');
                itemsBody.innerHTML = '';

                if (order.orderDetails && Array.isArray(order.orderDetails)) {
                    order.orderDetails.forEach(item => {
                        const row = document.createElement('tr');
                        const productName = item.productName || (item.product && item.product.name) || 'N/A';
                        const productPrice = item.unitPrice || (item.product && item.product.price) || 0;
                        const quantity = item.quantity || 0;
                        const subtotal = item.subtotal || (productPrice * quantity);
                        
                        row.innerHTML = `
                            <td>${productName}</td>
                            <td>${productPrice.toLocaleString('vi-VN')} VNƒê</td>
                            <td>${quantity}</td>
                            <td>${subtotal.toLocaleString('vi-VN')} VNƒê</td>
                        `;
                        itemsBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4">Kh√¥ng c√≥ chi ti·∫øt s·∫£n ph·∫©m</td>';
                    itemsBody.appendChild(row);
                }

                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'Pending': 'Ch·ªù x·ª≠ l√Ω',
                'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'Shipped': 'ƒêang v·∫≠n chuy·ªÉn',
                'Delivered': 'ƒê√£ giao',
                'Cancelled': 'H·ªßy b·ªè'
            };
            return statusMap[status] || status;
        }

        function setupModal() {
            const modal = document.getElementById('orderModal');
            const closeBtn = document.querySelector('.close');
            const closeModalBtn = document.querySelector('.close-modal');

            closeBtn.onclick = () => modal.style.display = 'none';
            closeModalBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };
        }
    </script>
</body>
</html>
