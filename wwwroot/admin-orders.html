<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω ƒê∆°n H√†ng</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üõçÔ∏è Qu·∫£n L√Ω B√°n H√†ng</h1>
            <div id="navMenu" class="nav-menu">
                <a href="index.html" class="nav-link">Trang Ch·ªß</a>
                <a href="products.html" class="nav-link" id="navProducts" style="display:none;">S·∫£n Ph·∫©m</a>
                <a href="admin-products.html" class="nav-link" id="navAdmin" style="display:none;">Qu·∫£n L√Ω S·∫£n Ph·∫©m</a>
                <a href="admin-orders.html" class="nav-link" id="navAdminOrders" style="display:none;">Qu·∫£n L√Ω ƒê∆°n H√†ng</a>
                <a href="cart.html" class="nav-link" id="navCart" style="display:none;">
                    üõí Gi·ªè H√†ng <span id="cartCount" class="badge">0</span>
                </a>
                <button id="logoutBtn" class="logout-btn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
        
        <div style="margin-bottom: 20px;">
            <label for="filterStatus">L·ªçc theo tr·∫°ng th√°i:</label>
            <select id="filterStatus" style="padding: 8px; margin-left: 10px;">
                <option value="">T·∫•t c·∫£</option>
                <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
                <option value="Shipped">ƒêang v·∫≠n chuy·ªÉn</option>
                <option value="Delivered">ƒê√£ giao</option>
                <option value="Cancelled">H·ªßy b·ªè</option>
            </select>
        </div>

        <table class="table" id="ordersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Kh√°ch H√†ng</th>
                    <th>Ng√†y ƒê·∫∑t</th>
                    <th>T·ªïng Ti·ªÅn</th>
                    <th>Tr·∫°ng Th√°i</th>
                    <th>H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
            </tbody>
        </table>

        <div id="noOrders" class="message message-info">
            ƒêang t·∫£i ƒë∆°n h√†ng...
        </div>
    </div>

    <!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
    <div id="orderModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close">&times;</span>
            <h3>Chi ti·∫øt ƒë∆°n h√†ng #<span id="modalOrderId"></span></h3>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <p><strong>Kh√°ch h√†ng:</strong> <span id="modalCustomerName"></span></p>
                        <p><strong>Email:</strong> <span id="modalCustomerEmail"></span></p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> <span id="modalCustomerPhone"></span></p>
                        <p><strong>Ng√†y ƒë·∫∑t:</strong> <span id="modalOrderDate"></span></p>
                    </div>
                    <div>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span id="modalOrderStatus"></span></p>
                        <p><strong>T·ªïng ti·ªÅn:</strong> <span id="modalOrderTotal"></span> VNƒê</p>
                        <p><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong> <span id="modalDeliveryAddress"></span></p>
                    </div>
                </div>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">Chi ti·∫øt s·∫£n ph·∫©m:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>S·∫£n Ph·∫©m</th>
                            <th>Gi√°</th>
                            <th>S·ªë L∆∞·ª£ng</th>
                            <th>Th√†nh Ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="modalOrderItems">
                    </tbody>
                </table>

                <div style="margin-top: 20px;">
                    <label for="statusSelect">C·∫≠p nh·∫≠t tr·∫°ng th√°i:</label>
                    <select id="statusSelect" style="padding: 8px; margin-left: 10px;">
                        <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                        <option value="Confirmed">ƒê√£ x√°c nh·∫≠n</option>
                        <option value="Shipped">ƒêang v·∫≠n chuy·ªÉn</option>
                        <option value="Delivered">ƒê√£ giao</option>
                        <option value="Cancelled">H·ªßy b·ªè</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="updateStatusBtn" class="btn btn-primary">C·∫≠p nh·∫≠t</button>
                <button id="deleteOrderBtn" class="btn btn-danger">X√≥a ƒê∆°n H√†ng</button>
                <button class="btn btn-secondary close-modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentOrderId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('Admin');
            updateNavigation();
            loadOrders();
            setupModal();
            setupFilter();
        });

        function setupFilter() {
            document.getElementById('filterStatus').addEventListener('change', function() {
                loadOrders(this.value);
            });
        }

        async function loadOrders(status = '') {
            try {
                const token = localStorage.getItem('token');
                let url = `${API_URL}/orders`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'L·ªói t·∫£i ƒë∆°n h√†ng');
                }

                const data = await response.json();
                let orders = Array.isArray(data) ? data : (data.data || []);

                // L·ªçc theo tr·∫°ng th√°i
                if (status) {
                    orders = orders.filter(order => order.status === status);
                }

                const ordersBody = document.getElementById('ordersBody');
                const noOrders = document.getElementById('noOrders');
                const ordersTable = document.getElementById('ordersTable');

                if (orders.length === 0) {
                    ordersTable.style.display = 'none';
                    noOrders.textContent = 'Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o';
                    noOrders.style.display = 'block';
                    return;
                }

                ordersBody.innerHTML = '';
                noOrders.style.display = 'none';
                ordersTable.style.display = 'table';

                orders.forEach(order => {
                    try {
                        const row = document.createElement('tr');
                        const statusBadge = getStatusBadge(order.status);
                        const customerName = order.customerName || order.customer?.name || 'N/A';
                        const orderDate = order.orderDate ? new Date(order.orderDate).toLocaleDateString('vi-VN') : 'N/A';
                        const totalAmount = order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') : '0';
                        
                        row.innerHTML = `
                            <td>#${order.id}</td>
                            <td>${customerName}</td>
                            <td>${orderDate}</td>
                            <td>${totalAmount} VNƒê</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewOrderDetails(${order.id})">Chi ti·∫øt</button>
                            </td>
                        `;
                        ordersBody.appendChild(row);
                    } catch (rowError) {
                        console.error('L·ªói hi·ªÉn th·ªã row:', rowError, order);
                    }
                });
            } catch (error) {
                console.error('L·ªói chi ti·∫øt:', error);
                const noOrders = document.getElementById('noOrders');
                const ordersTable = document.getElementById('ordersTable');
                ordersTable.style.display = 'none';
                noOrders.textContent = 'L·ªói t·∫£i ƒë∆°n h√†ng: ' + error.message;
                noOrders.style.display = 'block';
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                'Pending': '<span style="background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Ch·ªù x·ª≠ l√Ω</span>',
                'Confirmed': '<span style="background-color: #17a2b8; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒê√£ x√°c nh·∫≠n</span>',
                'Shipped': '<span style="background-color: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒêang v·∫≠n chuy·ªÉn</span>',
                'Delivered': '<span style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ƒê√£ giao</span>',
                'Cancelled': '<span style="background-color: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">H·ªßy b·ªè</span>'
            };
            return statusMap[status] || status;
        }

        async function viewOrderDetails(orderId) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng');
                }

                const data = await response.json();
                const order = data.data || data;

                currentOrderId = order.id;

                // Hi·ªÉn th·ªã th√¥ng tin ƒë∆°n h√†ng
                document.getElementById('modalOrderId').textContent = order.id || '';
                document.getElementById('modalCustomerName').textContent = order.customerName || order.customer?.name || 'N/A';
                document.getElementById('modalCustomerEmail').textContent = order.customer?.email || 'N/A';
                document.getElementById('modalCustomerPhone').textContent = order.phoneNumber || 'N/A';
                document.getElementById('modalDeliveryAddress').textContent = order.deliveryAddress || 'N/A';
                document.getElementById('modalOrderDate').textContent = order.orderDate ? new Date(order.orderDate).toLocaleDateString('vi-VN') : 'N/A';
                document.getElementById('modalOrderStatus').textContent = getStatusText(order.status) || 'N/A';
                document.getElementById('modalOrderTotal').textContent = order.totalAmount ? order.totalAmount.toLocaleString('vi-VN') : '0';
                document.getElementById('statusSelect').value = order.status || 'Pending';

                // Hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m
                const itemsBody = document.getElementById('modalOrderItems');
                itemsBody.innerHTML = '';

                if (order.orderDetails && Array.isArray(order.orderDetails)) {
                    order.orderDetails.forEach(item => {
                        try {
                            const row = document.createElement('tr');
                            // X·ª≠ l√Ω c·∫£ 2 format: ProductName (t·ª´ DTO) ho·∫∑c product.name (nested)
                            const productName = item.productName || (item.product && item.product.name) || 'N/A';
                            // X·ª≠ l√Ω c·∫£ 2 format: UnitPrice (t·ª´ DTO) ho·∫∑c product.price (nested)
                            const productPrice = item.unitPrice || (item.product && item.product.price) || 0;
                            const quantity = item.quantity || 0;
                            const subtotal = item.subtotal || (productPrice * quantity);
                            
                            row.innerHTML = `
                                <td>${productName}</td>
                                <td>${productPrice.toLocaleString('vi-VN')} VNƒê</td>
                                <td>${quantity}</td>
                                <td>${subtotal.toLocaleString('vi-VN')} VNƒê</td>
                            `;
                            itemsBody.appendChild(row);
                        } catch (itemError) {
                            console.error('L·ªói hi·ªÉn th·ªã item:', itemError, item);
                        }
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4">Kh√¥ng c√≥ chi ti·∫øt s·∫£n ph·∫©m</td>';
                    itemsBody.appendChild(row);
                }

                document.getElementById('orderModal').style.display = 'block';
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'Pending': 'Ch·ªù x·ª≠ l√Ω',
                'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
                'Shipped': 'ƒêang v·∫≠n chuy·ªÉn',
                'Delivered': 'ƒê√£ giao',
                'Cancelled': 'H·ªßy b·ªè'
            };
            return statusMap[status] || status;
        }

        function setupModal() {
            const modal = document.getElementById('orderModal');
            const closeBtn = document.querySelector('.close');
            const closeModalBtn = document.querySelector('.close-modal');

            closeBtn.onclick = () => modal.style.display = 'none';
            closeModalBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };

            document.getElementById('updateStatusBtn').onclick = updateOrderStatus;
            document.getElementById('deleteOrderBtn').onclick = deleteOrder;
        }

        async function deleteOrder() {
            if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng n√†y? D·ªØ li·ªáu s·∫Ω kh√¥ng th·ªÉ kh√¥i ph·ª•c.')) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/orders/${currentOrderId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'L·ªói x√≥a ƒë∆°n h√†ng');
                }

                alert('X√≥a ƒë∆°n h√†ng th√†nh c√¥ng!');
                document.getElementById('orderModal').style.display = 'none';
                loadOrders();
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }

        async function updateOrderStatus() {
            try {
                const newStatus = document.getElementById('statusSelect').value;
                const token = localStorage.getItem('token');

                const response = await fetch(`${API_URL}/orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: newStatus
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'L·ªói c·∫≠p nh·∫≠t ƒë∆°n h√†ng');
                }

                alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                document.getElementById('orderModal').style.display = 'none';
                loadOrders();
            } catch (error) {
                console.error('L·ªói:', error);
                alert('L·ªói: ' + error.message);
            }
        }
    </script>
</body>
</html>
