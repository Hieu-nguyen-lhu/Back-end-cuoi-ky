<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·ªè H√†ng</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üõçÔ∏è Qu·∫£n L√Ω B√°n H√†ng</h1>
            <div id="navMenu" class="nav-menu">
                <a href="index.html" class="nav-link">Trang Ch·ªß</a>
                <a href="products.html" class="nav-link" id="navProducts">S·∫£n Ph·∫©m</a>
                <a href="admin-products.html" class="nav-link" id="navAdmin" style="display:none;">Qu·∫£n L√Ω S·∫£n Ph·∫©m</a>
                <a href="admin-orders.html" class="nav-link" id="navAdminOrders" style="display:none;">Qu·∫£n L√Ω ƒê∆°n H√†ng</a>
                <a href="my-orders.html" class="nav-link" id="navMyOrders" style="display:none;">ƒê∆°n H√†ng C·ªßa T√¥i</a>
                <a href="cart.html" class="nav-link" id="navCart">üõí Gi·ªè H√†ng</a>
                <button id="logoutBtn" class="logout-btn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Gi·ªè H√†ng</h2>
        
        <div id="cartContainer" style="display:none;">
            <table class="table">
                <thead>
                    <tr>
                        <th>S·∫£n Ph·∫©m</th>
                        <th>Gi√°</th>
                        <th>S·ªë L∆∞·ª£ng</th>
                        <th>Th√†nh Ti·ªÅn</th>
                        <th>H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody id="cartItems">
                </tbody>
            </table>

            <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">Th√¥ng Tin Giao H√†ng</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="phoneNumber">S·ªë ƒêi·ªán Tho·∫°i:</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" pattern="[0-9]{10,11}">
                    </div>
                    <div class="form-group">
                        <label for="deliveryAddress">ƒê·ªãa Ch·ªâ Giao H√†ng:</label>
                        <input type="text" id="deliveryAddress" name="deliveryAddress" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng">
                    </div>
                </div>
            </div>

            <div class="cart-summary">
                <h3>T·ªïng C·ªông: <span id="totalAmount">0</span> VNƒê</h3>
                <button id="checkoutBtn" class="btn btn-primary" style="margin-right: 10px;">Thanh To√°n</button>
                <a href="products.html" class="btn btn-secondary">Ti·∫øp T·ª•c Mua S·∫Øm</a>
            </div>
        </div>

        <div id="emptyCart" class="message message-info" style="display:none;">
            Gi·ªè h√†ng tr·ªëng. <a href="products.html">Ti·∫øp t·ª•c mua s·∫Øm</a>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('User');
            loadCart();
            updateNavigation();
        });

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartContainer = document.getElementById('cartContainer');
            const emptyCart = document.getElementById('emptyCart');
            const cartItems = document.getElementById('cartItems');

            if (cart.length === 0) {
                cartContainer.style.display = 'none';
                emptyCart.style.display = 'block';
                return;
            }

            cartContainer.style.display = 'block';
            emptyCart.style.display = 'none';
            cartItems.innerHTML = '';

            let total = 0;
            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price.toLocaleString('vi-VN')} VNƒê</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" max="999" 
                            onchange="updateQuantity(${index}, this.value)" class="quantity-input">
                    </td>
                    <td>${subtotal.toLocaleString('vi-VN')} VNƒê</td>
                    <td><button class="btn btn-danger" onclick="removeFromCart(${index})">X√≥a</button></td>
                `;
                cartItems.appendChild(row);
            });

            document.getElementById('totalAmount').textContent = total.toLocaleString('vi-VN');
        }

        function updateQuantity(index, newQuantity) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const quantity = parseInt(newQuantity);
            
            if (quantity > 0) {
                cart[index].quantity = quantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                loadCart();
                updateCartCount();
            }
        }

        function removeFromCart(index) {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
            updateCartCount();
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartCountElements = document.querySelectorAll('#cartCount');
            cartCountElements.forEach(el => {
                el.textContent = count;
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const checkoutBtn = document.getElementById('checkoutBtn');
            if (checkoutBtn) {
                checkoutBtn.onclick = checkout;
            }
        });

        async function checkout() {
             const cart = JSON.parse(localStorage.getItem('cart')) || [];
             if (cart.length === 0) {
                 alert('Gi·ªè h√†ng tr·ªëng!');
                 return;
             }
        
             // Ki·ªÉm tra th√¥ng tin giao h√†ng
             const phoneNumber = document.getElementById('phoneNumber').value.trim();
             const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
             
             if (!phoneNumber) {
                 alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i');
                 return;
             }
             if (!deliveryAddress) {
                 alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng');
                 return;
             }
        
             const customerId = parseInt(localStorage.getItem('customerId'));
             if (!customerId) {
                 alert('Kh√¥ng t√¨m th·∫•y th√¥ng tin kh√°ch h√†ng');
                 return;
             }
        
             try {
                 const orderDetails = cart.map(item => ({
                     productId: item.id,
                     quantity: item.quantity
                 }));
        
                 const response = await fetch(`${API_URL}/orders`, {
                     method: 'POST',
                     headers: {
                         'Authorization': `Bearer ${localStorage.getItem('token')}`,
                         'Content-Type': 'application/json'
                     },
                     body: JSON.stringify({
                         customerId: customerId,
                         status: 'Pending',
                         orderDetails: orderDetails,
                         phoneNumber: phoneNumber,
                         deliveryAddress: deliveryAddress
                     })
                 });
        
                 if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.message || 'T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i');
                 }
        
                 const data = await response.json();
                 const orderId = data.data ? data.data.id : data.id;
                 
                 // X√≥a gi·ªè h√†ng
                 localStorage.removeItem('cart');
                 updateCartCount();
                 
                 // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                 showSuccessPage(orderId);
             } catch (error) {
                 console.error('L·ªói:', error);
                 alert('L·ªói: ' + error.message);
             }
         }

         function showSuccessPage(orderId) {
              const cartContainer = document.getElementById('cartContainer');
              const emptyCart = document.getElementById('emptyCart');
              
              cartContainer.style.display = 'none';
              emptyCart.style.display = 'block';
              
              emptyCart.innerHTML = `
                  <div class="message message-success" style="text-align: center; padding: 40px;">
                      <h2 style="color: #155724; margin-bottom: 20px;">‚úì Thanh To√°n Th√†nh C√¥ng!</h2>
                      <p style="font-size: 16px; margin-bottom: 10px;">ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng</p>
                      <p style="font-size: 16px; margin-bottom: 30px;"><strong>M√£ ƒë∆°n h√†ng: #${orderId}</strong></p>
                      <div>
                          <a href="my-orders.html" class="btn btn-primary" style="margin-right: 10px;">Xem ƒê∆°n H√†ng C·ªßa T√¥i</a>
                          <a href="products.html" class="btn btn-secondary" style="margin-right: 10px;">Ti·∫øp T·ª•c Mua S·∫Øm</a>
                          <a href="index.html" class="btn btn-secondary">V·ªÅ Trang Ch·ªß</a>
                      </div>
                  </div>
              `;
          }

        updateCartCount();
    </script>
</body>
</html>
