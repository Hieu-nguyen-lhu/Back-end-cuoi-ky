<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫£n Ph·∫©m</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1>üõçÔ∏è Qu·∫£n L√Ω B√°n H√†ng</h1>
            <div id="navMenu" class="nav-menu">
                <a href="index.html" class="nav-link">Trang Ch·ªß</a>
                <a href="products.html" class="nav-link" id="navProducts">S·∫£n Ph·∫©m</a>
                <a href="admin-products.html" class="nav-link" id="navAdmin" style="display:none;">Qu·∫£n L√Ω S·∫£n Ph·∫©m</a>
                <a href="admin-orders.html" class="nav-link" id="navAdminOrders" style="display:none;">Qu·∫£n L√Ω ƒê∆°n H√†ng</a>
                <a href="my-orders.html" class="nav-link" id="navMyOrders" style="display:none;">ƒê∆°n H√†ng C·ªßa T√¥i</a>
                <a href="cart.html" class="nav-link" id="navCart">
                    üõí Gi·ªè H√†ng <span id="cartCount" class="badge">0</span>
                </a>
                <button id="logoutBtn" class="logout-btn" style="display:none;">ƒêƒÉng Xu·∫•t</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <h2>Danh S√°ch S·∫£n Ph·∫©m</h2>
        
        <div id="productsGrid" class="products-grid">
            <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
        </div>

        <div id="noProducts" class="message message-info">
            ƒêang t·∫£i s·∫£n ph·∫©m...
        </div>
    </div>

    <!-- Modal chi ti·∫øt s·∫£n ph·∫©m -->
    <div id="productModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle"></h3>
            <div class="modal-body">
                <p><strong>Gi√°:</strong> <span id="modalPrice"></span> VNƒê</p>
                <p><strong>T·ªìn kho:</strong> <span id="modalStock"></span></p>
                <p><strong>M√¥ t·∫£:</strong> <span id="modalDescription"></span></p>
                <div class="form-group">
                    <label for="quantityInput">S·ªë l∆∞·ª£ng:</label>
                    <input type="number" id="quantityInput" min="1" value="1">
                </div>
            </div>
            <div class="modal-footer">
                <button id="addToCartBtn" class="btn btn-primary">Th√™m v√†o gi·ªè h√†ng</button>
                <button class="btn btn-secondary close-modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentProductId = null;

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth('User');
            loadProducts();
            updateNavigation();
            setupModal();
        });

        async function loadProducts() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/products`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('L·ªói t·∫£i s·∫£n ph·∫©m');

                const data = await response.json();
                const products = data.data;
                const productsGrid = document.getElementById('productsGrid');
                const noProducts = document.getElementById('noProducts');

                if (products.length === 0) {
                    productsGrid.style.display = 'none';
                    noProducts.textContent = 'Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o';
                    noProducts.style.display = 'block';
                    return;
                }

                productsGrid.innerHTML = '';
                noProducts.style.display = 'none';

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    
                    // T·∫°o img element n·∫øu c√≥ h√¨nh ·∫£nh
                    if (product.imageUrl && product.imageUrl.trim() !== '') {
                        const img = document.createElement('img');
                        img.src = product.imageUrl;
                        img.alt = product.name;
                        img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;';
                        img.onerror = function() {
                            this.style.display = 'none';
                            const placeholder = document.createElement('div');
                            placeholder.style.cssText = 'width: 100%; height: 200px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;';
                            placeholder.textContent = 'Kh√¥ng c√≥ h√¨nh ·∫£nh';
                            this.parentElement.insertBefore(placeholder, this);
                        };
                        card.appendChild(img);
                    } else {
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = 'width: 100%; height: 200px; background-color: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;';
                        placeholder.textContent = 'Kh√¥ng c√≥ h√¨nh ·∫£nh';
                        card.appendChild(placeholder);
                    }
                    
                    // Th√™m th√¥ng tin s·∫£n ph·∫©m
                    const content = document.createElement('div');
                    content.innerHTML = `
                        <h3>${product.name}</h3>
                        <p class="price">${product.price.toLocaleString('vi-VN')} VNƒê</p>
                        <p class="stock">T·ªìn kho: ${product.stock}</p>
                        <p class="description">${product.description || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                        <button class="btn btn-primary" onclick="openProductModal(${product.id}, '${product.name.replace(/'/g, "\\'")}', ${product.price}, ${product.stock}, '${(product.description || '').replace(/'/g, "\\'")}')">
                            Th√™m v√†o gi·ªè
                        </button>
                    `;
                    card.appendChild(content);
                    productsGrid.appendChild(card);
                });
            } catch (error) {
                console.error('L·ªói:', error);
                document.getElementById('noProducts').textContent = 'L·ªói t·∫£i s·∫£n ph·∫©m';
                document.getElementById('noProducts').style.display = 'block';
            }
        }

        function openProductModal(id, name, price, stock, description) {
            currentProductId = id;
            document.getElementById('modalTitle').textContent = name;
            document.getElementById('modalPrice').textContent = price.toLocaleString('vi-VN');
            document.getElementById('modalStock').textContent = stock;
            document.getElementById('modalDescription').textContent = description || 'Kh√¥ng c√≥ m√¥ t·∫£';
            document.getElementById('quantityInput').value = 1;
            document.getElementById('quantityInput').max = stock;
            document.getElementById('productModal').style.display = 'block';
        }

        function setupModal() {
            const modal = document.getElementById('productModal');
            const closeBtn = document.querySelector('.close');
            const closeModalBtn = document.querySelector('.close-modal');

            closeBtn.onclick = () => modal.style.display = 'none';
            closeModalBtn.onclick = () => modal.style.display = 'none';
            window.onclick = (event) => {
                if (event.target === modal) modal.style.display = 'none';
            };

            document.getElementById('addToCartBtn').onclick = addToCart;
        }

        function addToCart() {
            const quantity = parseInt(document.getElementById('quantityInput').value);
            if (quantity <= 0) {
                alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0');
                return;
            }

            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            const existingItem = cart.find(item => item.id === currentProductId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                // L·∫•y gi√° t·ª´ modal, lo·∫°i b·ªè t·∫•t c·∫£ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
                const priceText = document.getElementById('modalPrice').textContent;
                const price = parseFloat(priceText.replace(/\D/g, '')) || 0;
                
                const product = {
                    id: currentProductId,
                    name: document.getElementById('modalTitle').textContent,
                    price: price,
                    quantity: quantity
                };
                cart.push(product);
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            
            // ƒê√≥ng modal
            document.getElementById('productModal').style.display = 'none';
            
            // Hi·ªÉn th·ªã th√¥ng b√°o
            alert('ƒê√£ th√™m v√†o gi·ªè h√†ng! T·ªïng: ' + quantity + ' s·∫£n ph·∫©m');
        }

        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = count;
        }

        updateCartCount();
    </script>
</body>
</html>
